<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Energy Data</title>
</head>
<body>
  <h1>Live Energy Data</h1>
  <div id="live-data"></div>

  <script>
    async function setupWebSocket() {
      // Set the WebSocket connection manually (you could also fetch it dynamically from Tibber API as before)
      const wsUrl = 'wss://websocket-api.tibber.com/v1-beta/gql/subscriptions';
      const socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        console.log('WebSocket connection established');
        const message = JSON.stringify({
          type: 'connection_init',
          payload: {
            Authorization: 'Bearer 6MraYaGDqZnOzV2gz0jOgnrnTV0fXG65vaeeMtsggc4'
          }
        });
        socket.send(message);

        const subscription = JSON.stringify({
          id: '1',
          type: 'start',
          payload: {
            query: `subscription {
              liveMeasurement(homeId:"cba5d658-1fc0-4f68-b5ea-09c39d531f23") {
                timestamp
                power
                accumulatedConsumption
                accumulatedCost
                currency
                minPower
                averagePower
                maxPower
              }
            }`
          }
        });
        socket.send(subscription);
      };

      socket.onmessage = (event) => {
        console.log('Received data:', event.data);
        const data = JSON.parse(event.data);
        if (data.type === 'data') {
          const measurement = data.payload.data.liveMeasurement;
          const displayData = `
            <p>Timestamp: ${measurement.timestamp}</p>
            <p>Power: ${measurement.power} W</p>
            <p>Accumulated Consumption: ${measurement.accumulatedConsumption} kWh</p>
            <p>Accumulated Cost: ${measurement.accumulatedCost || 'N/A'} ${measurement.currency || ''}</p>
            <p>Min Power: ${measurement.minPower} W</p>
            <p>Average Power: ${measurement.averagePower} W</p>
            <p>Max Power: ${measurement.maxPower} W</p>
            <hr>
          `;
          document.getElementById('live-data').innerHTML = displayData;
        }
      };

      socket.onerror = (error) => {
        console.error('WebSocket error:', error);
      };

      socket.onclose = () => {
        console.log('WebSocket connection closed');
      };
    }

    setupWebSocket();
  </script>
</body>
</html>
